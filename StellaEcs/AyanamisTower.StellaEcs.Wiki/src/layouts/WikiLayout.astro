---
import Layout from "./Layout.astro";
import Sidebar from "../components/Sidebar.svelte";
import fs from "fs";
import path from "path";

const { frontmatter } = Astro.props;
const title = frontmatter?.title || "Wiki";

// Generate navItems dynamically from folder structure
const wikiPath = path.join(process.cwd(), "src", "pages", "wiki");
const folders = fs
    .readdirSync(wikiPath, { withFileTypes: true })
    .filter((dirent) => dirent.isDirectory())
    .map((dirent) => dirent.name);

// Load frontmatters for sorting
const pageModules = import.meta.glob("/src/pages/wiki/**/*.mdx", {
    eager: true,
}) as Record<string, { frontmatter: any }>;
const frontmatters: Record<string, any> = {};
for (const [path, module] of Object.entries(pageModules)) {
    const relativePath = path
        .replace("/src/pages/wiki/", "")
        .replace(".mdx", "");
    frontmatters[relativePath] = module.frontmatter;
}

const navItems = folders
    .map((folder) => {
        const folderPath = path.join(wikiPath, folder);
        const files = fs
            .readdirSync(folderPath)
            .filter(
                (file) =>
                    file.endsWith(".astro") ||
                    file.endsWith(".md") ||
                    file.endsWith(".mdx")
            )
            .map((file) => file.replace(/\.astro$|\.md$|\.mdx$/, ""));

        const children = files
            .map((file) => {
                let title;
                let pagePath;
                let sortOrder;
                if (file === "index") {
                    title = "Overview";
                    pagePath = `/wiki/${folder}/`;
                    sortOrder =
                        frontmatters[`${folder}/index`]?.sidebarOrder || 0;
                } else {
                    title = file
                        .split("-")
                        .map(
                            (word) =>
                                word.charAt(0).toUpperCase() + word.slice(1)
                        )
                        .join(" ");
                    pagePath = `/wiki/${folder}/${file}`;
                    sortOrder =
                        frontmatters[`${folder}/${file}`]?.sidebarOrder || 999;
                }
                return { title, path: pagePath, sortOrder };
            })
            .sort((a, b) => {
                if (a.sortOrder !== b.sortOrder) {
                    return a.sortOrder - b.sortOrder;
                }
                return a.title.localeCompare(b.title);
            });

        const sectionTitle = folder.charAt(0).toUpperCase() + folder.slice(1);
        const sectionSortOrder =
            frontmatters[`${folder}/index`]?.sidebarOrder || 999;
        return {
            title: sectionTitle,
            path: `/wiki/${folder}`,
            children,
            sortOrder: sectionSortOrder,
        };
    })
    .sort((a, b) => {
        if (a.sortOrder !== b.sortOrder) {
            return a.sortOrder - b.sortOrder;
        }
        return a.title.localeCompare(b.title);
    });
---

<Layout>
    <div class="flex h-screen overflow-hidden">
        <aside class="w-64 flex-shrink-0">
            <Sidebar navItems={navItems} client:load />
        </aside>
        <main class="flex-1 overflow-y-auto p-8">
            <div class="max-w-4xl mx-auto">
                <article>
                    <h1 class="text-4xl font-bold mb-6 text-yellow-400">
                        {title}
                    </h1>
                    <div class="prose prose-invert max-w-none">
                        <slot />
                    </div>
                </article>
            </div>
        </main>
    </div>
</Layout>
