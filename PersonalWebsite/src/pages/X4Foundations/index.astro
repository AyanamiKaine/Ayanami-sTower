---
import Layout from "../../layouts/Layout.astro";

const allPostsGlob = import.meta.glob("./*/*.mdx", { eager: true });
const allPosts = Object.values(allPostsGlob);
const now = new Date();
const publishedPosts = allPosts.filter((post) => {
    return (
        post.frontmatter.published && new Date(post.frontmatter.created) <= now
    );
});

const postsByCategory = publishedPosts.reduce((acc, post) => {
    const category = post.frontmatter.category || "uncategorized";
    if (!acc[category]) acc[category] = [];
    acc[category].push(post);
    return acc;
}, {});

for (const category in postsByCategory) {
    postsByCategory[category].sort((a, b) => {
        const orderA = a.frontmatter.order ?? Infinity;
        const orderB = b.frontmatter.order ?? Infinity;
        if (orderA !== orderB) {
            return orderA - orderB;
        }
        return a.frontmatter.title.localeCompare(b.frontmatter.title);
    });
}

const chapterOrder = ["getting-started", "cookbooks", "references", "advanced"];

const chapterDescriptions = {
    "getting-started":
        "Begin your modding journey with setup guides and first mod tutorials",
    cookbooks: "Step-by-step recipes for common modding tasks",
    references: "Data reference for ships, DLC, races, factions, and more",
    advanced:
        "Complex topics including scripting, AI behavior, and engine deep dives",
};

// We don't filter categories anymore, we want to show all of them
function formatCategoryName(name) {
    return name
        .split("-")
        .map((word) => word.charAt(0).toUpperCase() + word.slice(1))
        .join(" ");
}
---

<Layout title="X4 Foundations Modding Guide">
    <div class="max-w-5xl mx-auto px-4">
        <!-- Hero Section -->
        <div class="hero-section text-center py-12">
            <h1 class="text-5xl font-bold mb-4">X4 Foundations</h1>
            <h2
                class="text-3xl text-blue-600 dark:text-blue-400 font-semibold mb-6"
            >
                Modding Guide by Ayanami Kaine
            </h2>
            <p
                class="text-xl text-gray-600 dark:text-gray-400 max-w-2xl mx-auto"
            >
                A comprehensive guide to modding X4: Foundations. From your
                first mod to advanced scripting.
            </p>
        </div>

        <!-- Quick Links -->
        <div class="quick-links grid grid-cols-2 md:grid-cols-4 gap-4 mb-16">
            {
                chapterOrder.map((category) => (
                    <a href={`#${category}`} class="quick-link-card">
                        <span class="quick-link-title">
                            {formatCategoryName(category)}
                        </span>
                        <span class="quick-link-count">
                            {postsByCategory[category]?.length || 0} articles
                        </span>
                    </a>
                ))
            }
        </div>

        <!-- Content Tables -->
        <div class="space-y-16">
            {
                chapterOrder.map((category, index) => (
                    <section id={category} class="scroll-mt-20">
                        <div class="section-header border-b-2 border-gray-200 dark:border-gray-700 pb-4 mb-6">
                            <h3 class="text-2xl font-bold text-gray-900 dark:text-white flex items-center gap-3">
                                <span class="text-blue-600 dark:text-blue-400 text-lg opacity-80">
                                    #{index + 1}
                                </span>
                                {formatCategoryName(category)}
                            </h3>
                            {chapterDescriptions[category] && (
                                <p class="text-gray-600 dark:text-gray-400 mt-2 max-w-3xl">
                                    {chapterDescriptions[category]}
                                </p>
                            )}
                        </div>

                        {postsByCategory[category] &&
                        postsByCategory[category].length > 0 ? (
                            <div class="overflow-x-auto">
                                <table class="w-full text-left border-collapse">
                                    <thead>
                                        <tr class="border-b border-gray-200 dark:border-gray-700">
                                            <th class="py-3 px-4 font-semibold text-gray-700 dark:text-gray-300 w-1/3">
                                                Topic
                                            </th>
                                            <th class="py-3 px-4 font-semibold text-gray-700 dark:text-gray-300">
                                                Description
                                            </th>
                                            <th class="py-3 px-4 font-semibold text-gray-700 dark:text-gray-300 w-32">
                                                Tags
                                            </th>
                                        </tr>
                                    </thead>
                                    <tbody class="divide-y divide-gray-100 dark:divide-gray-800">
                                        {postsByCategory[category].map(
                                            (post) => (
                                                <tr class="hover:bg-gray-50 dark:hover:bg-gray-800/50 transition-colors">
                                                    <td class="py-4 px-4 align-top">
                                                        <a
                                                            href={post.url}
                                                            class="font-medium text-blue-600 dark:text-blue-400 hover:underline block"
                                                        >
                                                            {
                                                                post.frontmatter
                                                                    .title
                                                            }
                                                        </a>
                                                        <span class="text-xs text-gray-400 mt-1 block">
                                                            {new Date(
                                                                post.frontmatter
                                                                    .created,
                                                            ).toLocaleDateString(
                                                                "en-US",
                                                                {
                                                                    month: "short",
                                                                    day: "numeric",
                                                                    year: "numeric",
                                                                },
                                                            )}
                                                        </span>
                                                    </td>
                                                    <td class="py-4 px-4 align-top text-gray-600 dark:text-gray-400 text-sm">
                                                        {post.frontmatter
                                                            .description ||
                                                            "No description available."}
                                                    </td>
                                                    <td class="py-4 px-4 align-top">
                                                        <div class="flex flex-wrap gap-1">
                                                            {post.frontmatter
                                                                .tags &&
                                                                post.frontmatter.tags
                                                                    .slice(0, 3)
                                                                    .map(
                                                                        (
                                                                            tag,
                                                                        ) => (
                                                                            <span class="inline-block px-2 py-0.5 text-xs rounded bg-blue-50 dark:bg-blue-900/30 text-blue-700 dark:text-blue-300 border border-blue-100 dark:border-blue-900/50">
                                                                                {
                                                                                    tag
                                                                                }
                                                                            </span>
                                                                        ),
                                                                    )}
                                                        </div>
                                                    </td>
                                                </tr>
                                            ),
                                        )}
                                    </tbody>
                                </table>
                            </div>
                        ) : (
                            <div class="bg-gray-50 dark:bg-gray-800/50 rounded-lg p-8 text-center border border-dashed border-gray-300 dark:border-gray-700">
                                <p class="text-gray-500 dark:text-gray-400 italic">
                                    No guides available in this section yet.
                                </p>
                            </div>
                        )}
                    </section>
                ))
            }
        </div>

        <div
            class="mt-20 border-t border-gray-200 dark:border-gray-700 pt-8 text-center text-gray-500 text-sm"
        >
            <p>
                All content written by Ayanami Kaine for the X4 modding
                community.
            </p>
        </div>
    </div>
</Layout>

<style>
    .hero-section {
        border-bottom: 1px solid #e5e7eb;
        margin-bottom: 3rem;
    }

    .quick-link-card {
        display: flex;
        flex-direction: column;
        align-items: center;
        padding: 1.25rem;
        background: white;
        border-radius: 0.75rem;
        text-decoration: none;
        transition: all 0.2s ease;
        border: 1px solid #e5e7eb;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
    }

    .quick-link-card:hover {
        transform: translateY(-2px);
        box-shadow:
            0 10px 15px -3px rgba(0, 0, 0, 0.1),
            0 4px 6px -2px rgba(0, 0, 0, 0.05);
        border-color: #3b82f6;
    }

    .quick-link-title {
        font-weight: 700;
        color: #1f2937;
        font-size: 1rem;
    }

    .quick-link-count {
        font-size: 0.8rem;
        color: #6b7280;
        margin-top: 0.25rem;
    }

    @media (prefers-color-scheme: dark) {
        .hero-section {
            border-bottom-color: #374151;
        }

        .quick-link-card {
            background: #1f2937;
            border-color: #374151;
        }

        .quick-link-title {
            color: #f3f4f6;
        }

        .quick-link-count {
            color: #9ca3af;
        }

        .quick-link-card:hover {
            border-color: #3b82f6;
        }
    }
</style>
